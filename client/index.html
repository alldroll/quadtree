<!DOCTYPE html>
<head>
    <style type="text/css">
html, body { height: 100%; margin: 0; padding: 0; }
#map { height: 800px; width: 600px }
    </style>
    <meta charset="utf-8">
</head>
<body>
    <div id="map"></div>
    <script type="text/javascript">

var app = (function() {
    var IMAGE_PATH = 'https://googlemaps.github.io/js-marker-clusterer/images/m',
    IMAGE_EXT = 'png',
    ICONS_COUNT = 5;

    var TileSystem = (function() {
        var TILE_SIZE = 256;

        function getTileXY(latLng, zoom) {
            var scale = 1 << zoom;
            var worldCoordinate = project(latLng);
            return [
                Math.floor(worldCoordinate.x * scale / TILE_SIZE),
                Math.floor(worldCoordinate.y * scale / TILE_SIZE)
            ];
        }

        function project(latLng) {
            var siny = Math.sin(latLng.lat() * Math.PI / 180);
            siny = Math.min(Math.max(siny, -0.9999), 0.9999);
            return new google.maps.Point(
                TILE_SIZE * (0.5 + latLng.lng() / 360),
                TILE_SIZE * (0.5 - Math.log((1 + siny) / (1 - siny)) / (4 * Math.PI))
            );
        }

        return {
            getTileXY: getTileXY
        }
    })();

    function init() {
        var ws = new WebSocket("{{.WSPath}}");
        var map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 43.124365, lng: 131.889356},
            zoom: {{.Zoom}}
        });

        var Cluster = function(data) {
            this.lat = data.lat;
            this.lng = data.lng;
            this.count = data.count;
        };

        Cluster.prototype.getCount = function() {
            return this.count;
        };

        Cluster.prototype.getPosition = function() {
            return {lat: this.lat, lng: this.lng};
        };

        Cluster.prototype.getIcon = function() {
            var dv = this.count || 0,
            index = 0;

            while (dv !== 0 && index <= ICONS_COUNT) {
                dv = parseInt(dv / 10);
                index++;
            }

            return IMAGE_PATH + index + '.' + IMAGE_EXT;
        };

        Cluster.prototype.getLabel = function() {
            return this.count.toString();
        };

        Cluster.prototype.asMarker = function() {
            return new google.maps.Marker({
                position: this.getPosition(),
                map: map,
                label: this.getLabel(),
                icon: this.getIcon()
            });
        }

        var markers = [];

        var curBounds = null;

        var getMarkers = function(flush) {
            var bounds = map.getBounds(), zoom = map.getZoom();
            var tileBounds = TileSystem.getTileXY(bounds.getSouthWest(), zoom)
                .concat(TileSystem.getTileXY(bounds.getNorthEast(), zoom));

            var toSend = {
                lat1: bounds.b.b,
                lng1: bounds.f.f,
                lat2: bounds.b.f,
                lng2: bounds.f.b,
                tileBounds: tileBounds,
                zoom: zoom
            };

            ws.send(JSON.stringify(toSend))
        };

        var addMarker = function(cluster) {
            markers.push(cluster.asMarker());
        };

        function setMapOnAll(map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        var clearAllMarkers = function() {
            setMapOnAll(null);
        };

        var deleteAllMarkers = function() {
            clearAllMarkers(null);
            markers = [];
        }

        ws.onmessage = function(event) {
            deleteAllMarkers();
            var a = JSON.parse(event.data), sum = 0, cluster;
            for (var k in a) {
                cluster = new Cluster(a[k]);
                addMarker(cluster);
                sum += cluster.getCount();
            }

            console.log('ADDED '+ sum + ' CNT');
        };

        map.addListener('idle', function() {getMarkers(); });

        //map.addListener('zoom_changed', function() {getMarkers(true);});
    }

    return {
        init: init
    };

})();
    </script>

    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key={{.ApiKey}}&callback=app.init">
    </script>

    <!--<script async defer type="text/javascript"-->
<!--src="https://googlemaps.github.io/js-marker-clusterer/src/markerclusterer.js">-->
<!--</script>-->

</body>
</html>
