<!DOCTYPE html>
<head>
    <style type="text/css">
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { height: 800px; width: 600px }
    </style>
    <meta charset="utf-8">
</head>
<body>
    <div id="map"></div>
    <script type="text/javascript">

        function initMap() {
            var ws = new WebSocket("{{.WSPath}}");
            var map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 43.124365, lng: 131.889356},
                zoom: {{.Zoom}}
            });

            var markers = [];

            var showMarkers = function() {
                var bounds = map.getBounds();
                console.log(bounds);
                var toSend = {
                    lat1: bounds.b.b,
                    lon1: bounds.f.f,
                    lat2: bounds.b.f,
                    lon2: bounds.f.b,
                    zoom: map.getZoom()
                };

                console.log(JSON.stringify(toSend))

                ws.send(JSON.stringify(toSend))
            };

            var addMarker = function(lat, lng, cnt) {
                var marker = new google.maps.Marker({
                    position: {
                        lat: lat,
                        lng: lng
                    },
                    map: map,
                    label: cnt + ""
                });
                markers.push(marker);
            };

            function setMapOnAll(map) {
                for (var i = 0; i < markers.length; i++) {
                    markers[i].setMap(map);
                }
            }

            var clearAllMarkers = function() {
                setMapOnAll(null);
            };

            var deleteAllMarkers = function() {
                clearAllMarkers(null);
                markers = [];
            }

            ws.onmessage = function(event) {
                deleteAllMarkers();
                var a = JSON.parse(event.data), sum = 0;
                for (var k in a) {
                    addMarker(a[k].Lat, a[k].Lon, a[k].Cnt);
                    sum += a[k].Cnt;
                }

                /*
                var markerCluster = new MarkerClusterer(
                    map,
                    markers,
                    {
                        imagePath: 'https://googlemaps.github.io/js-marker-clusterer/images/m'
                    }
                );
                */
                console.log('ADDED '+ sum + ' CNT');
            };

            map.addListener('idle', showMarkers);
        }
    </script>

    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key={{.ApiKey}}&callback=initMap">
    </script>
    <script async defer type="text/javascript"
            src="https://googlemaps.github.io/js-marker-clusterer/src/markerclusterer.js">
    </script>

</body>
</html>
