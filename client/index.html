<!DOCTYPE html>
<head>
    <style type="text/css">
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { height: 800px; width: 600px }
    </style>
    <meta charset="utf-8">
</head>
<body>
    <div id="map"></div>
    <script type="text/javascript">

        var app = (function() {
            var IMAGE_PATH = 'https://googlemaps.github.io/js-marker-clusterer/images/m',
                IMAGE_EXT = 'png',
                ICONS_COUNT = 5;

            function init() {
                var ws = new WebSocket("{{.WSPath}}");
                var map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 43.124365, lng: 131.889356},
                    zoom: {{.Zoom}}
                });

                var Cluster = function(data) {
                    this.lat = data.lat;
                    this.lng = data.lng;
                    this.count = data.count;
                };

                Cluster.prototype.getCount = function() {
                    return this.count;
                };

                Cluster.prototype.getPosition = function() {
                    return {lat: this.lat, lng: this.lng};
                };

                Cluster.prototype.getIcon = function() {
                    var dv = this.count || 0,
                        index = 0;

                    while (dv !== 0 && index <= ICONS_COUNT) {
                        dv = parseInt(dv / 10);
                        index++;
                    }

                    return IMAGE_PATH + index + '.' + IMAGE_EXT;
                };

                Cluster.prototype.getLabel = function() {
                    return this.count.toString();
                };

                Cluster.prototype.asMarker = function() {
                    return new google.maps.Marker({
                        position: this.getPosition(),
                        map: map,
                        label: this.getLabel(),
                        icon: this.getIcon()
                    });
                }

                var markers = [];

                var curBounds = null;

                var getMarkers = function(flush) {
                    var bounds = map.getBounds();
                    var wasChanged = false;

                    if (flush) {
                        curBounds = null;
                    }

                    if (curBounds === null) {
                        curBounds = getBBounds(bounds);
                        wasChanged = true;
                    }

                    if (!curBounds.contains(bounds.getNorthEast()) || !curBounds.contains(bounds.getSouthWest())) {
                        curBounds = getBBounds(bounds);
                        wasChanged = true;
                    }

                    if (!wasChanged) {
                        return;
                    }

                    bounds = curBounds;

                    var toSend = {
                        lat1: bounds.b.b,
                        lng1: bounds.f.f,
                        lat2: bounds.b.f,
                        lng2: bounds.f.b,
                        zoom: map.getZoom()
                    };

                    ws.send(JSON.stringify(toSend))
                };

                var getBBounds = function(bounds) {
                    var pointNorthEast = bounds.getNorthEast();
                    var pointSouthWest = bounds.getSouthWest();
                    var latAdjustment = (pointNorthEast.lat() - pointSouthWest.lat()) * 0.5;
                    var lngAdjustment = (pointNorthEast.lng() - pointSouthWest.lng()) * 0.5;
                    var newPointNorthEast = new google.maps.LatLng(pointNorthEast.lat() + latAdjustment, pointNorthEast.lng() + lngAdjustment);
                    var newPointSouthWest = new google.maps.LatLng(pointSouthWest.lat() - latAdjustment, pointSouthWest.lng() - lngAdjustment);

                    var newBounds = new google.maps.LatLngBounds();
                    newBounds.extend(newPointNorthEast);
                    newBounds.extend(newPointSouthWest);
                    return newBounds;
                }

                var addMarker = function(cluster) {
                    markers.push(cluster.asMarker());
                };

                function setMapOnAll(map) {
                    for (var i = 0; i < markers.length; i++) {
                        markers[i].setMap(map);
                    }
                }

                var clearAllMarkers = function() {
                    setMapOnAll(null);
                };

                var deleteAllMarkers = function() {
                    clearAllMarkers(null);
                    markers = [];
                }

                ws.onmessage = function(event) {
                    deleteAllMarkers();
                    var a = JSON.parse(event.data), sum = 0, cluster;
                    for (var k in a) {
                        cluster = new Cluster(a[k]);
                        addMarker(cluster);
                        sum += cluster.getCount();
                    }

                    console.log('ADDED '+ sum + ' CNT');
                };

                map.addListener('idle', getMarkers);

                map.addListener('zoom_changed', function() {getMarkers(true);});
            }

            return {
                init: init
            };

        })();
    </script>

    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key={{.ApiKey}}&callback=app.init">
    </script>

    <!--<script async defer type="text/javascript"-->
            <!--src="https://googlemaps.github.io/js-marker-clusterer/src/markerclusterer.js">-->
    <!--</script>-->

</body>
</html>
